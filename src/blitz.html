<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>âš¡ Fast Math Blitz</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      width: 100%;
      margin: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .game-section {
      margin-top: 20px;
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #1f2937;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #374151;
    }

    .hidden {
      display: none;
    }

    #blitzFeed {
      margin-top: 15px;
      padding: 10px;
      background: #f3f4f6;
      border-radius: 6px;
      min-height: 40px;
      font-size: 14px;
    }

    #blitzScoresRow {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      text-decoration: none;
      color: #1f2937;
      font-weight: bold;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.db = db;
    window.ref = ref;
    window.set = set;
    window.push = push;
    window.onValue = onValue;
    window.update = update;
  </script>
</head>
<body>
  <div class="container">
    <a href="dashboard.html" class="back-link"><i class="bx bx-arrow-back"></i> Back to Dashboard</a>
    <h1>âš¡ Fast Math Blitz</h1>

    <!-- Lobby -->
    <div id="blitzLobby">
      <p>Challenge a friend to a real-time math race!</p>
      <input type="text" id="blitzFriendInput" placeholder="Enter friend's full name" />
      <button id="blitzInviteBtn">Send Invite</button>
      <p id="blitzInviteStatus"></p>

      <h4>Incoming Blitz Invites</h4>
      <ul id="blitzIncomingList"></ul>
    </div>

    <!-- Game Section -->
    <div id="blitzGame" class="hidden game-section">
      <div id="blitzTop">
        <p id="blitzStatus">Get Readyâ€¦</p>
        <p id="blitzTimer">Next problem in: â€”</p>
      </div>

      <h2 id="blitzProblem">â€”</h2>

      <div id="blitzAnswerRow">
        <input type="number" id="blitzAnswer" placeholder="Your answer" disabled />
        <button id="blitzSubmitBtn" class="hidden">Submit</button>
      </div>

      <div id="blitzScoresRow">
        <p id="blitzScore">You: 0 | Opponent: 0</p>
        <p id="blitzStreak">ðŸ”¥ Streak: 0</p>
      </div>

      <div id="blitzFeed" aria-live="polite"></div>

      <button id="blitzExitBtn">Exit Blitz</button>
    </div>
  </div>

  <script type="module">
    import { db, ref, set, push, onValue, update } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

    const blitzLobby = document.getElementById("blitzLobby");
    const blitzGame = document.getElementById("blitzGame");
    const blitzStatus = document.getElementById("blitzStatus");
    const blitzTimer = document.getElementById("blitzTimer");
    const blitzProblem = document.getElementById("blitzProblem");
    const blitzAnswer = document.getElementById("blitzAnswer");
    const blitzSubmitBtn = document.getElementById("blitzSubmitBtn");
    const blitzScore = document.getElementById("blitzScore");
    const blitzStreak = document.getElementById("blitzStreak");
    const blitzFeed = document.getElementById("blitzFeed");
    const blitzExitBtn = document.getElementById("blitzExitBtn");

    let score = 0;
    let opponentScore = 0;
    let streak = 0;
    let currentAnswer = null;
    let roundTimer;
    let currentGameId = null;
    let playerNumber = 1; // 1 or 2

    function generateProblem() {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      return { a, b, answer: a + b };
    }

    function updateUI(data) {
      if (!data) return;
      blitzStatus.textContent = data.status === "waiting" ? "Waiting for opponent..." : "Solve the problem!";
      const problem = data.currentProblem;
      if (problem) {
        blitzProblem.textContent = `${problem.a} + ${problem.b} = ?`;
        currentAnswer = problem.answer;
        blitzAnswer.disabled = false;
        blitzSubmitBtn.classList.remove("hidden");
        blitzAnswer.value = "";
        blitzAnswer.focus();
      }

      if (playerNumber === 1) opponentScore = data.score2 || 0;
      else opponentScore = data.score1 || 0;

      blitzScore.textContent = `You: ${score} | Opponent: ${opponentScore}`;
      blitzStreak.textContent = `ðŸ”¥ Streak: ${streak}`;
    }

    function listenGame(gameId) {
      const gameRef = ref(db, `blitzGames/${gameId}`);
      onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        updateUI(data);
      });
    }

    function startNewRound() {
      const problem = generateProblem();
      currentAnswer = problem.answer;
      blitzAnswer.disabled = false;
      blitzSubmitBtn.classList.remove("hidden");
      blitzAnswer.value = "";
      blitzAnswer.focus();
      blitzTimer.textContent = "Next problem in: 10s";

      update(ref(db, `blitzGames/${currentGameId}`), {
        currentProblem: problem,
        status: "active"
      });

      clearInterval(roundTimer);
      let timeLeft = 10;
      roundTimer = setInterval(() => {
        timeLeft--;
        blitzTimer.textContent = `Time Left: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(roundTimer);
          handleWrong();
        }
      }, 1000);
    }

    function handleCorrect() {
      score++;
      streak++;
      blitzFeed.textContent = "âœ… Correct!";
      if (playerNumber === 1) update(ref(db, `blitzGames/${currentGameId}`), { score1: score });
      else update(ref(db, `blitzGames/${currentGameId}`), { score2: score });
      startNewRound();
    }

    function handleWrong() {
      streak = 0;
      blitzFeed.textContent = "âŒ Wrong or timeâ€™s up!";
      startNewRound();
    }

    blitzSubmitBtn.addEventListener("click", () => {
      const val = parseInt(blitzAnswer.value);
      if (val === currentAnswer) handleCorrect();
      else handleWrong();
    });

    blitzExitBtn.addEventListener("click", () => {
      clearInterval(roundTimer);
      blitzLobby.classList.remove("hidden");
      blitzGame.classList.add("hidden");
      score = opponentScore = streak = 0;
      blitzFeed.textContent = "";
      blitzProblem.textContent = "â€”";
      blitzTimer.textContent = "Next problem in: â€”";
      if (currentGameId) update(ref(db, `blitzGames/${currentGameId}`), { status: "finished" });
    });

    document.getElementById("blitzInviteBtn").addEventListener("click", async () => {
      const friendName = document.getElementById("blitzFriendInput").value.trim();
      if (!friendName) return alert("Enter a friend's name.");

      const gameRef = push(ref(db, "blitzGames"));
      await set(gameRef, {
        player1: "You",
        player2: friendName,
        score1: 0,
        score2: 0,
        currentProblem: null,
        status: "waiting"
      });

      blitzLobby.classList.add("hidden");
      blitzGame.classList.remove("hidden");
      currentGameId = gameRef.key;
      playerNumber = 1;

      listenGame(currentGameId);
      startNewRound();
    });
  </script>
</body>
</html>
